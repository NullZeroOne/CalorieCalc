<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Game of Life PRD</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2em; line-height: 1.6; background: #fff; color: #000; }
  h1,h2,h3,h4 { color: #003366; }
  pre { background: #f4f4f4; padding: 1em; overflow-x: auto; }
  code { color: #660000; }
  nav ul { list-style: none; padding: 0; }
  nav ul li { margin: .3em 0; }
</style>
</head>
<body>
<h1>Product Requirements Document<br>Conway's Game of Life — Extended Web App</h1>

<nav>
<h2>Table of Contents</h2>
<ul>
  <li>1. Introduction</li>
  <li>2. Defaults</li>
  <li>3. User Interface</li>
  <li>4. Controls & Editing</li>
  <li>5. Simulation Rules</li>
  <li>6. Aging & Population Rebalancing</li>
  <li>7. Visualization Modes</li>
  <li>8. History & Stepping</li>
  <li>9. Diagnostics</li>
  <li>10. Presets Feature</li>
  <li>11. Favicon & Branding</li>
  <li>12. Keyboard Shortcuts</li>
  <li>13. Pseudocode</li>
  <li>Appendix A. Preset Pattern Definitions</li>
</ul>
</nav>

<h2>1. Introduction</h2>
<p>This document defines requirements for the extended Conway’s Game of Life web app, including UI layout, simulation behavior, visualization, presets, and special rules.</p>

<h2>2. Defaults</h2>
<ul>
<li>Block size: 15 pixels</li>
<li>Default fill percentage: 10%</li>
<li>Default fill/draw color: White (#FFFFFF) on black background</li>
<li>History buffer size: 20 states</li>
<li>Initial state: <strong>R-pentomino</strong> centered on board</li>
<li>Toroidal topology: Enabled by default</li>
</ul>

<h2>3. User Interface</h2>
<ul>
<li>Controls panel on the left (narrow, white-on-black theme)</li>
<li>Play ▶️, Pause ⏸️, Step Back ⬅️, Step Forward ➡️, Clear in first row</li>
<li>Block Size input + Resize button below</li>
<li>Fill % input and color picker swatch in next row</li>
<li>Fill region 3×3 grid of arrows + Quarters + Presets buttons</li>
<li>Options arranged:</li>
<ul>
<li>Line 1: Toroidal</li>
<li>Line 2: Rainbow, Trends</li>
<li>Line 3: Aging, Birth Rate</li>
<li>Line 4: PopRebal, Threshold %</li>
</ul>
<li>On-canvas gradient legend for Trends; no sidebar legend</li>
</ul>

<h2>4. Controls & Editing</h2>
<ul>
<li>Click = draw; Shift+Click = erase; dragging supported</li>
<li>Fill buttons activate percentage fill in selected region</li>
<li>Fill does not clear existing board; re-fills are cumulative</li>
<li>Clear button resets board and history</li>
<li>Resizing preserves board contents (anchored top-left)</li>
</ul>

<h2>5. Simulation Rules</h2>
<p>Standard Conway’s Life rules (B3/S23) unless modified by rebalancing:</p>
<ul>
<li>Cell survives with 2 or 3 neighbors</li>
<li>Empty cell becomes alive with 3 neighbors</li>
<li>Population rebalancing can modify thresholds (see Section 6)</li>
</ul>

<h2>6. Aging & Population Rebalancing</h2>
<ul>
<li>Aging enabled: A cell dies if it was alive for the entire history window</li>
<li>Birth Rate (BR): Number of new cells spawned per aged death (default 2)</li>
<li>Population Rebalancing active only when Aging is enabled</li>
<li>Rebalancing modifies births per aged death:</li>
<ul>
<li>Population &lt; Fill% − Threshold → BR+1</li>
<li>Within range → BR</li>
<li>Population &gt; Fill% + Threshold → BR−1 (min 0)</li>
</ul>
<li>Spawn placement: radial search outward from dying cell, randomizing candidates per ring</li>
</ul>

<h2>7. Visualization Modes</h2>
<ul>
<li><strong>Rainbow mode</strong>: New cell color = average of neighbors’ RGB; if from aging, average of neighbors else inherits dying cell color</li>
<li><strong>Trends mode</strong>: Cells colored by activity fraction across history window; gradient white → blue → teal → green → yellow → orange → red</li>
<li>Non-rainbow rendering displays stored cell colors (not just B/W)</li>
</ul>

<h2>8. History & Stepping</h2>
<ul>
<li>20-step buffer, cursor-based navigation</li>
<li>Step Back and Step Forward navigate snapshots</li>
<li>Snapshots include board state, colors, and generation</li>
<li>Clear clears board and history</li>
<li>Bug fix: can step back to initial R-pentomino</li>
</ul>

<h2>9. Diagnostics</h2>
<ul>
<li>Diagnostic panel at bottom of sidebar, now <strong>stacked/narrow format</strong>:</li>
<pre><code>FPS: 30.2 | Gen: 128
Alive: 1200 (12.5%)
Size: 80×60
History: 10/20
</code></pre>
<li>FPS updated during play; persists when paused</li>
</ul>

<h2>10. Presets Feature</h2>
<ul>
<li>Presets button opens modal with pattern cards</li>
<li>Patterns clear board + history and insert centered pattern</li>
<li>Supports both coordinate lists and RLE parsing</li>
</ul>

<h2>11. Favicon & Branding</h2>
<ul>
<li>Uses GameOfLife.* icons (16, 32, 192, 512, apple-touch 180, ICO)</li>
<li>Icon is R-pentomino, consistent with initial state</li>
</ul>

<h2>12. Keyboard Shortcuts</h2>
<ul>
<li>Space: Play/Pause</li>
<li>Left Arrow: Step Back</li>
<li>Right Arrow: Step Forward</li>
</ul>

<h2>13. Pseudocode</h2>
<h3>Simulation Step</h3>
<pre><code>function stepOnce():
  measure current alive%
  adjust rules if rebalancing+aging active
  for each cell:
    count neighbors (wrap if toroidal)
    apply rules:
      - alive cell survives (2 or 3 neighbors, or ≥3 if modified)
      - dead cell born (3 neighbors, or 2–3 if modified low-pop rule)
    assign color:
      - rainbow: average neighbor colors
      - non-rainbow: fill color
  if aging enabled and history full:
    for each cell alive full history:
      kill cell
      compute spawns = BR (± per rebalancing)
      place new cells by radial search
      color new cells = avg neighbors or dying color
  increment generation
</code></pre>

<h3>History Management</h3>
<pre><code>pushSnap():
  if cursor not at tip, truncate redo branch
  append deep copy of grid/colors/gen
  trim to historyCap
  move cursor to last
</code></pre>

<h3>Trend Coloring</h3>
<pre><code>for each cell:
  frac = alive_count_in_history / window_size
  color = gradient(frac)
</code></pre>

<h3>Radial Spawn Placement</h3>
<pre><code>function findRadialEmpty(r,c):
  for d=1 to max(rows,cols):
    collect perimeter cells distance d
    shuffle perimeter list
    return first empty cell
  return null
</code></pre>

<h2>Appendix A. Preset Pattern Definitions</h2>
<h3>A.1 Coordinates</h3>
<ul>
<li>Block, Beehive, Loaf, Boat</li>
<li>Blinker, Toad, Beacon</li>
<li>Glider, LWSS</li>
<li>R-pentomino, Diehard, Acorn</li>
</ul>
<h3>A.2 RLE</h3>
<ul>
<li>Pulsar (p3 oscillator)</li>
<li>Pentadecathlon (p15)</li>
<li>Gosper Glider Gun (p30 gun)</li>
</ul>
<p>Other patterns (MWSS, HWSS, Simkin gun, Puffer Train, etc.) can be added via RLE in the same system.</p>

</body>
</html>
