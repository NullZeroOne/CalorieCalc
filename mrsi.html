<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MRSI Animation with Sound Fronts (until last sound arrival)</title>
  <style>
    html, body { height: 100%; margin: 0; background: #fff; color: #111; font-family: system-ui, sans-serif; }
    .wrap { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem; }
    canvas { background: #fff; border: 1px solid #ccc; max-width: 100%; height: auto; }
    .caption { font-size: 0.95rem; text-align: center; max-width: 980px; line-height: 1.35; }
    .meta { font-size: 0.9rem; color: #444; }
    .small { font-size: 0.85rem; color: #555; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0.2rem 0;">MRSI Demonstration with Sound Fronts</h1>
    <div class="caption">
      Projectiles (solid lines) land together at a common impact time. For each shot, a dashed circle of the same color
      shows the expanding sound wave of the gun report, starting at that shot’s fire time and propagating at the speed
      of sound (<em>c</em> = 343&nbsp;m/s). The simulation continues until the <em>last</em> shot’s sound reaches
      the target at distance <em>R</em>.
    </div>
    <canvas id="plot" width="1080" height="640"></canvas>
    <div class="meta" id="readout"></div>
    <div class="small" id="notes"></div>
  </div>

  <script>
  (function(){
    const g=9.81, c_sound=343, RANGE_M=15000, ANGLES_DEG=[25,35,45,55,65];
    const REALTIME_SCALE=1.0, MARGIN_TIME=2.0, PADDING={left:70,right:20,top:20,bottom:60};
    const canvas=document.getElementById("plot"), ctx=canvas.getContext("2d");
    const readout=document.getElementById("readout"), notes=document.getElementById("notes");

    function setupHiDPI(){const dpr=window.devicePixelRatio||1;const rect=canvas.getBoundingClientRect();
      canvas.width=Math.round(rect.width*dpr);canvas.height=Math.round(rect.height*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);}
    (function(){canvas.style.width=canvas.width+"px";canvas.style.height=canvas.height+"px";setupHiDPI();
      window.addEventListener("resize",setupHiDPI);})();

    const anglesRad=ANGLES_DEG.map(a=>a*Math.PI/180);
    const vMuzzle=anglesRad.map(th=>Math.sqrt(RANGE_M*g/Math.sin(2*th)));
    const tFlight=anglesRad.map((th,i)=>2*vMuzzle[i]*Math.sin(th)/g);
    const T_impact=Math.max(...tFlight);
    const tFire=tFlight.map(tf=>T_impact-tf);
    const tSoundAtTarget=RANGE_M/c_sound;
    const tSoundArrivals=tFire.map(t0=>t0+tSoundAtTarget);
    const lastSoundArrival=Math.max(...tSoundArrivals);
    const tStop=lastSoundArrival+MARGIN_TIME;

    const maxHeights=anglesRad.map((th,i)=>{const vy=vMuzzle[i]*Math.sin(th);return vy*vy/(2*g);});
    const yMax=Math.max(10,Math.max(...maxHeights)*1.1), xMax=RANGE_M*1.05;

    function plotRect(){const w=canvas.width/(window.devicePixelRatio||1),h=canvas.height/(window.devicePixelRatio||1);
      const availW=w-PADDING.left-PADDING.right,availH=h-PADDING.top-PADDING.bottom;
      const scale=Math.min(availW/xMax,availH/yMax);return{x:PADDING.left,y:PADDING.top+(availH-yMax*scale),w:xMax*scale,h:yMax*scale,scale};}
    function xToPx(x){const r=plotRect();return r.x+x*r.scale;}function yToPx(y){const r=plotRect();return r.y+r.h-Math.max(0,y)*r.scale;}

    function projectileXY(v,th,t){return[v*Math.cos(th)*t,Math.max(0,v*Math.sin(th)*t-0.5*g*t*t)];}
    function colorFor(i,n){return`hsl(${Math.round(360*i/n)} 70% 40%)`;}

    function drawAxes(){const r=plotRect();ctx.save();ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle="#333";ctx.beginPath();ctx.moveTo(xToPx(0),yToPx(0));ctx.lineTo(xToPx(xMax),yToPx(0));ctx.stroke();
      ctx.beginPath();ctx.moveTo(xToPx(0),yToPx(0));ctx.lineTo(xToPx(0),yToPx(yMax));ctx.stroke();ctx.restore();}

    function drawLegend(){const r=plotRect(),x0=r.x+10,y0=r.y+10,lh=16;ctx.save();ctx.font="12px system-ui";ctx.textAlign="left";
      const boxH=lh*(ANGLES_DEG.length+2)+12;ctx.fillStyle="rgba(255,255,255,0.85)";ctx.fillRect(x0-6,y0-6,460,boxH);
      ctx.strokeStyle="rgba(0,0,0,0.25)";ctx.strokeRect(x0-6,y0-6,460,boxH);
      ctx.fillStyle="#111";ctx.fillText("θ | v (m/s) | fire @ t₀ | flight | sound @ target",x0,y0+lh*0.5);
      ANGLES_DEG.forEach((ang,i)=>{const y=y0+lh*(i+1.5);ctx.fillStyle=colorFor(i,ANGLES_DEG.length);
        ctx.fillRect(x0,y-5,18,4);ctx.fillStyle="#111";
        ctx.fillText(`${ang}° | v=${vMuzzle[i].toFixed(1)} | t₀=${tFire[i].toFixed(2)}s | ${tFlight[i].toFixed(2)}s | ${tSoundArrivals[i].toFixed(2)}s`,x0+26,y);});
      ctx.fillStyle="#333";ctx.fillText(`Common impact: ${T_impact.toFixed(2)}s | Last sound @ target: ${lastSoundArrival.toFixed(2)}s`,x0,y0+lh*(ANGLES_DEG.length+1.5));
      ctx.restore();}

    let startReal=null;
    function step(ts){if(startReal===null)startReal=ts;const tNow=Math.min(tStop,(ts-startReal)/1000/REALTIME_SCALE);
      drawAxes();
      // sound fronts
      ANGLES_DEG.forEach((ang,i)=>{const dt=tNow-tFire[i];if(dt>0){const r=plotRect(),rad=c_sound*dt*r.scale;ctx.save();
        ctx.setLineDash([6,6]);ctx.strokeStyle=colorFor(i,ANGLES_DEG.length);ctx.beginPath();ctx.arc(xToPx(0),yToPx(0),rad,0,2*Math.PI);ctx.stroke();ctx.restore();
        if(tNow>=tSoundArrivals[i]){ctx.fillStyle=colorFor(i,ANGLES_DEG.length);ctx.beginPath();ctx.arc(xToPx(RANGE_M),yToPx(0),3,0,2*Math.PI);ctx.fill();}}});
      // trajectories
      ANGLES_DEG.forEach((ang,i)=>{const th=anglesRad[i],v=vMuzzle[i],t0=tFire[i],tf=tFlight[i],tau=tNow-t0;ctx.beginPath();if(tau>0){
        const tauEff=Math.min(tau,tf),n=Math.max(5,Math.floor(200*tauEff/tf));
        for(let k=0;k<=n;k++){const [x,y]=projectileXY(v,th,(tauEff*k)/n);const xp=xToPx(x),yp=yToPx(y);if(k===0)ctx.moveTo(xp,yp);else ctx.lineTo(xp,yp);}}
        ctx.strokeStyle=colorFor(i,ANGLES_DEG.length);ctx.stroke();});
      if(tNow>=T_impact){ctx.fillStyle="#000";ctx.beginPath();ctx.arc(xToPx(RANGE_M),yToPx(0),4,0,2*Math.PI);ctx.fill();}
      drawLegend();
      readout.textContent=`Sim time: ${tNow.toFixed(2)}s | Impact: ${T_impact.toFixed(2)}s | Last sound: ${lastSoundArrival.toFixed(2)}s`;
      notes.textContent="Assumptions: no drag, level ground, constant g=9.81 m/s², c=343 m/s.";
      if(tNow<tStop)requestAnimationFrame(step);}
    requestAnimationFrame(step);
  })();
  </script>
</body>
</html>
